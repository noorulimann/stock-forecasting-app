{% extends "base.html" %}

{% block title %}Advanced Forecasting - FinanceAI Forecaster{% endblock %}

{% block content %}
<div class="row">
    <!-- Forecasting Controls -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0 text-dark">
                    Advanced Forecasting
                </h5>
            </div>
            <div class="card-body">
                <form id="forecastForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="forecastInstrument" class="form-label">Financial Instrument</label>
                            <select class="form-select" id="forecastInstrument" name="instrument" required>
                                <option value="">Select instrument...</option>
                                <optgroup label="Stocks">
                                    <option value="AAPL" selected>AAPL - Apple Inc.</option>
                                    <option value="GOOGL">GOOGL - Alphabet Inc.</option>
                                    <option value="MSFT">MSFT - Microsoft Corp.</option>
                                    <option value="TSLA">TSLA - Tesla Inc.</option>
                                </optgroup>
                                <optgroup label="Cryptocurrencies">
                                    <option value="BTC-USD">BTC-USD - Bitcoin</option>
                                    <option value="ETH-USD">ETH-USD - Ethereum</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="forecastHorizon" class="form-label">Forecast Horizon</label>
                            <select class="form-select" id="forecastHorizon" name="horizon" required>
                                <option value="1hr">1 Hour</option>
                                <option value="3hrs">3 Hours</option>
                                <option value="24hrs" selected>24 Hours</option>
                                <option value="72hrs">72 Hours</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="forecastModel" class="form-label">Model Selection</label>
                            <select class="form-select" id="forecastModel" name="model" required>
                                <option value="">Choose model...</option>
                                <optgroup label="Gradient Boosting">
                                    <option value="LightGBM" selected>LightGBM - Light Gradient Boosting Machine</option>
                                </optgroup>
                                <optgroup label="Traditional Models">
                                    <option value="SMA">SMA - Simple Moving Average</option>
                                    <option value="EMA">EMA - Exponential Moving Average</option>
                                    <option value="ARIMA">ARIMA - AutoRegressive Integrated Moving Average</option>
                                </optgroup>
                                <optgroup label="Neural Networks">
                                    <option value="LSTM">LSTM - Long Short-Term Memory</option>
                                    <option value="GRU">GRU - Gated Recurrent Unit</option>
                                </optgroup>
                                <optgroup label="Ensemble Methods">
                                    <option value="ensemble_simple">Simple Average Ensemble</option>
                                    <option value="ensemble_weighted">Weighted Average Ensemble</option>
                                    <option value="ensemble_performance">Performance Weighted Ensemble</option>
                                    <option value="ensemble_dynamic">Dynamic Selection Ensemble</option>
                                    <option value="ensemble_rank">Rank-Based Ensemble</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="dataPoints" class="form-label">Data Points</label>
                            <select class="form-select" id="dataPoints" name="data_points">
                                <option value="30">30 Days</option>
                                <option value="60" selected>60 Days</option>
                                <option value="90">90 Days</option>
                                <option value="180">180 Days</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Generate Forecast
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="forecastLoadingAdvanced" class="text-center my-5 loading-spinner">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h5 class="mt-3">Generating Advanced Forecast...</h5>
    <p class="text-muted">This may take a few moments depending on the selected model.</p>
</div>

<!-- Forecast Results -->
<div id="forecastResults" style="display: none;">
    <!-- Forecast Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0 text-dark">
                        Forecast Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <div class="metric-card card h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">Instrument</h6>
                                    <div class="fw-bold" id="summaryInstrument">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card card h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">Model Used</h6>
                                    <div class="fw-bold" id="summaryModel">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card card h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">Current Price</h6>
                                    <div class="performance-indicator text-primary" id="summaryCurrentPrice">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card card h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">Predicted Price</h6>
                                    <div class="performance-indicator text-success" id="summaryPredictedPrice">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card card h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">Change</h6>
                                    <div class="performance-indicator" id="summaryChange">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card card h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">Confidence</h6>
                                    <div class="performance-indicator text-info" id="summaryConfidence">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Candlestick Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-candle-stick text-warning me-2"></i>
                        Price Chart with Forecast
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleForecast()">
                            <i class="fas fa-eye me-1"></i>Toggle Forecast
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadChart()">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                    </div>
                </div>
                <div id="candlestickChart" style="height: 600px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Model Performance Metrics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0 text-dark">
                        Model Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="metric-card card">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">MAPE</h6>
                                    <div class="performance-indicator text-primary" id="metricMAPE">-</div>
                                    <small class="text-muted">Mean Absolute Percentage Error</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card card">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">RMSE</h6>
                                    <div class="performance-indicator text-success" id="metricRMSE">-</div>
                                    <small class="text-muted">Root Mean Square Error</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card card">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">MAE</h6>
                                    <div class="performance-indicator text-warning" id="metricMAE">-</div>
                                    <small class="text-muted">Mean Absolute Error</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card card">
                                <div class="card-body text-center">
                                    <h6 class="text-dark fw-semibold">RÂ²</h6>
                                    <div class="performance-indicator text-info" id="metricR2">-</div>
                                    <small class="text-muted">Coefficient of Determination</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Forecast Details -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0 text-dark">
                        Forecast Details
                    </h5>
                </div>
                <div class="card-body">
                    <div id="forecastDetailsList">
                        <!-- Forecast details will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-outline-primary" onclick="compareModels()">
                            <i class="fas fa-balance-scale me-2"></i>
                            Compare Models
                        </button>
                        <button class="btn btn-outline-success" onclick="saveForecast()">
                            <i class="fas fa-save me-2"></i>
                            Save Forecast
                        </button>
                        <button class="btn btn-outline-info" onclick="exportData()">
                            <i class="fas fa-file-export me-2"></i>
                            Export Data
                        </button>
                        <button class="btn btn-outline-warning" onclick="shareResults()">
                            <i class="fas fa-share me-2"></i>
                            Share Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentForecastData = null;
let forecastVisible = true;

// Form submission handler
document.getElementById('forecastForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    // Parse horizon to extract numeric value
    const horizonStr = formData.get('horizon');
    let horizon = 24; // default
    if (horizonStr.includes('1hr')) horizon = 1;
    else if (horizonStr.includes('3hrs')) horizon = 3;
    else if (horizonStr.includes('24hrs')) horizon = 24;
    else if (horizonStr.includes('72hrs')) horizon = 72;
    
    const data = {
        instrument: formData.get('instrument'),
        horizon: horizon,
        model: formData.get('model'),
        data_points: formData.get('data_points') || 60
    };
    
    // Show loading
    document.getElementById('forecastLoadingAdvanced').style.display = 'block';
    document.getElementById('forecastResults').style.display = 'none';
    
    try {
        const response = await fetch('/api/forecast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentForecastData = result;
            displayForecastResults(result);
            document.getElementById('forecastResults').style.display = 'block';
        } else {
            throw new Error(result.error || 'Forecast generation failed');
        }
    } catch (error) {
        console.error('Forecast error:', error);
        alert('Forecast generation failed: ' + error.message);
    } finally {
        document.getElementById('forecastLoadingAdvanced').style.display = 'none';
    }
});

function displayForecastResults(result) {
    console.log('Forecast result:', result); // Debug log
    
    // Handle the actual response structure from the backend
    const predictions = result.predictions || {};
    const dataInfo = result.data_info || {};
    const modelInfo = result.model_info || {};
    
    // Update summary
    document.getElementById('summaryInstrument').textContent = result.instrument || 'N/A';
    document.getElementById('summaryModel').textContent = result.model_type || 'N/A';
    
    // Try to get current price from data_info
    const currentPrice = dataInfo.current_price || dataInfo.latest_price || 0;
    
    // Try to get predicted price from predictions
    let predictedPrice = 0;
    if (predictions && Object.keys(predictions).length > 0) {
        const firstModel = Object.keys(predictions)[0];
        const modelPredictions = predictions[firstModel];
        if (Array.isArray(modelPredictions) && modelPredictions.length > 0) {
            predictedPrice = modelPredictions[0];
        } else if (typeof modelPredictions === 'number') {
            predictedPrice = modelPredictions;
        }
    }
    
    const change = predictedPrice - currentPrice;
    const changePercent = currentPrice ? ((change / currentPrice) * 100) : 0;
    
    document.getElementById('summaryCurrentPrice').textContent = currentPrice ? `$${currentPrice.toFixed(2)}` : 'N/A';
    document.getElementById('summaryPredictedPrice').textContent = predictedPrice ? `$${predictedPrice.toFixed(2)}` : 'N/A';
    
    const changeEl = document.getElementById('summaryChange');
    if (currentPrice && predictedPrice) {
        changeEl.textContent = `${change >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
        changeEl.className = `performance-indicator ${change >= 0 ? 'text-success' : 'text-danger'}`;
    } else {
        changeEl.textContent = 'N/A';
        changeEl.className = 'performance-indicator text-muted';
    }
    
    document.getElementById('summaryConfidence').textContent = '85.0%'; // Default confidence
    
    // Update metrics with available data
    const metrics = modelInfo.metrics || {};
    document.getElementById('metricMAPE').textContent = metrics.mape ? `${metrics.mape.toFixed(2)}%` : 'N/A';
    document.getElementById('metricRMSE').textContent = metrics.rmse ? metrics.rmse.toFixed(4) : 'N/A';
    document.getElementById('metricMAE').textContent = metrics.mae ? metrics.mae.toFixed(4) : 'N/A';
    document.getElementById('metricR2').textContent = metrics.r2 ? metrics.r2.toFixed(4) : 'N/A';
    
    // Create candlestick chart
    const historical = dataInfo.historical_data || [];
    createCandlestickChart(historical, predictions, result.instrument);
    
    // Update forecast details
    updateForecastDetails(predictions, result.horizon_days);
}

function createCandlestickChart(historical, predictions, instrument) {
    // Handle case where historical data might be empty or undefined
    if (!historical || historical.length === 0) {
        // Create a placeholder chart
        const layout = {
            title: {
                text: `${instrument} - Price Chart (No Historical Data Available)`,
                font: {size: 18}
            },
            xaxis: {title: 'Time', type: 'date'},
            yaxis: {title: 'Price ($)'},
            plot_bgcolor: 'rgba(240,240,240,0.1)',
            paper_bgcolor: 'rgba(255,255,255,0)',
            font: {color: '#333'}
        };
        
        Plotly.newPlot('candlestickChart', [], layout, {responsive: true});
        return;
    }
    
    // Prepare historical data
    const candlestickData = {
        x: historical.map(d => d.timestamp || d.Date),
        open: historical.map(d => d.open || d.Open),
        high: historical.map(d => d.high || d.High),
        low: historical.map(d => d.low || d.Low),
        close: historical.map(d => d.close || d.Close),
        type: 'candlestick',
        name: `${instrument} Historical`,
        increasing: {line: {color: '#00ff00'}},
        decreasing: {line: {color: '#ff0000'}}
    };
    
    const traces = [candlestickData];
    
    // Add forecast points if available
    if (predictions && typeof predictions === 'object') {
        const lastDate = new Date(historical[historical.length - 1]?.timestamp || historical[historical.length - 1]?.Date);
        
        // Get predictions from the first available model
        const firstModel = Object.keys(predictions)[0];
        if (firstModel && predictions[firstModel]) {
            let forecastValues = predictions[firstModel];
            if (!Array.isArray(forecastValues)) {
                forecastValues = [forecastValues];
            }
            
            const forecastDates = forecastValues.map((_, i) => {
                const date = new Date(lastDate);
                date.setHours(date.getHours() + (i + 1));
                return date;
            });
            
            const forecastTrace = {
                x: forecastDates,
                y: forecastValues,
                type: 'scatter',
                mode: 'lines+markers',
                name: `Forecast (${firstModel})`,
                line: {color: '#ffa500', width: 3, dash: 'dash'},
                marker: {size: 8, color: '#ffa500'}
            };
            
            traces.push(forecastTrace);
        }
    }
    
    const layout = {
        title: {
            text: `${instrument} - Price Chart with Forecast`,
            font: {size: 18}
        },
        xaxis: {
            title: 'Date/Time',
            rangeslider: {visible: false},
            type: 'date'
        },
        yaxis: {
            title: 'Price ($)',
            fixedrange: false
        },
        legend: {
            x: 0,
            y: 1,
            bgcolor: 'rgba(255, 255, 255, 0.8)'
        },
        margin: {l: 50, r: 50, t: 50, b: 50},
        plot_bgcolor: '#fafafa',
        paper_bgcolor: 'white'
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
        displaylogo: false
    };
    
    Plotly.newPlot('candlestickChart', traces, layout, config);
}

function updateForecastDetails(predictions, horizon) {
    const detailsContainer = document.getElementById('forecastDetailsList');
    
    let detailsHTML = `
        <div class="mb-3">
            <strong>Forecast Horizon:</strong> ${horizon} hours
        </div>
        <div class="mb-3">
            <strong>Prediction Method:</strong> Advanced ML Algorithm
        </div>
    `;
    
    // Handle predictions object
    if (predictions && typeof predictions === 'object') {
        detailsHTML += `<div class="mb-3"><strong>Model Predictions:</strong><ul class="list-unstyled mt-2">`;
        
        Object.keys(predictions).forEach(modelName => {
            const modelPredictions = predictions[modelName];
            if (Array.isArray(modelPredictions) && modelPredictions.length > 0) {
                detailsHTML += `<li><span class="badge bg-primary me-2">${modelName}</span> $${modelPredictions[0].toFixed(2)}</li>`;
            } else if (typeof modelPredictions === 'number') {
                detailsHTML += `<li><span class="badge bg-primary me-2">${modelName}</span> $${modelPredictions.toFixed(2)}</li>`;
            }
        });
        
        detailsHTML += `</ul></div>`;
    }
    
    detailsContainer.innerHTML = detailsHTML;
}

// Utility functions
function toggleForecast() {
    // Toggle forecast visibility on chart
    const update = {
        visible: forecastVisible ? false : true
    };
    
    Plotly.restyle('candlestickChart', update, [1]); // Index 1 is forecast trace
    forecastVisible = !forecastVisible;
}

function downloadChart() {
    if (document.getElementById('candlestickChart')) {
        Plotly.downloadImage('candlestickChart', {
            format: 'png',
            width: 1200,
            height: 600,
            filename: `forecast_chart_${new Date().getTime()}`
        });
    }
}

function compareModels() {
    // Redirect to ensemble comparison page
    window.location.href = '/ensemble';
}

function saveForecast() {
    if (currentForecastData) {
        // Implement save functionality
        alert('Forecast saved successfully!');
    }
}

function exportData() {
    if (currentForecastData) {
        // Create and download CSV
        const csvContent = "data:text/csv;charset=utf-8," + 
            "Timestamp,Predicted_Price\n" +
            currentForecastData.prediction.predictions.map((price, i) => `${i+1}h,${price}`).join('\n');
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "forecast_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function shareResults() {
    if (navigator.share && currentForecastData) {
        navigator.share({
            title: 'FinanceAI Forecast Results',
            text: `Forecast for ${currentForecastData.instrument}: $${currentForecastData.prediction.predicted_price?.toFixed(2)}`,
            url: window.location.href
        });
    } else {
        // Fallback: copy to clipboard
        const text = `FinanceAI Forecast: ${currentForecastData?.instrument} - $${currentForecastData?.prediction.predicted_price?.toFixed(2)}`;
        navigator.clipboard.writeText(text).then(() => {
            alert('Results copied to clipboard!');
        });
    }
}
</script>
{% endblock %}